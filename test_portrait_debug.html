<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Portrait Debug Test</title>
    <style>
        body { background: #222; color: #fff; padding: 20px; font-family: Arial; }
        .portrait-box { 
            width: 150px; height: 150px; 
            position: relative; border: 2px solid #444; 
            background: #111; overflow: hidden; margin: 20px 0;
        }
        .portrait-box img { width: 100%; height: 100%; object-fit: cover; }
        .upload-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); color: white;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s; cursor: pointer;
        }
        .portrait-box:hover .upload-overlay { opacity: 1; }
        #log { background: #333; padding: 10px; margin: 20px 0; font-family: monospace; }
        button { padding: 10px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Portrait Upload Debug</h1>
    
    <h2>Test Setup (mimics game interface)</h2>
    <div id="test-container"></div>
    
    <h2>Debug Controls</h2>
    <button onclick="simulateCharacterLoad()">Simulate Character Load</button>
    <button onclick="checkFunction()">Check uploadPortrait Function</button>
    <button onclick="manualTrigger()">Manual Trigger Upload</button>
    
    <h2>Log</h2>
    <div id="log"></div>
    
    <script>
        function log(msg) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${msg}<br>`;
            console.log(msg);
        }
        
        // Simulate the uploadPortrait function from game
        function uploadPortrait(characterName) {
            log(`uploadPortrait called with: ${characterName}`);
            const input = document.getElementById('portrait-upload-input');
            if (!input) {
                log('ERROR: Input not found!');
                return;
            }
            const file = input.files[0];
            if (!file) {
                log('No file selected');
                return;
            }
            log(`File selected: ${file.name} (${file.size} bytes)`);
            
            // Simulate upload
            const formData = new FormData();
            formData.append('portrait', file);
            formData.append('characterName', characterName);
            
            log('Uploading to server...');
            fetch('/upload-portrait', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                log(`Server response: ${JSON.stringify(data)}`);
                // Reset input
                input.value = '';
                log('Input reset for re-selection');
            })
            .catch(error => {
                log(`Upload error: ${error}`);
            });
        }
        
        // Make it global like in game
        window.uploadPortrait = uploadPortrait;
        
        function simulateCharacterLoad() {
            // This mimics what displayCharacterStats does
            const normalizedName = 'test_character';
            const container = document.getElementById('test-container');
            
            const html = `
                <div class="portrait-box">
                    <img id="char-portrait-img" 
                         src="/static/portraits/${normalizedName}.png" 
                         onerror="this.onerror=null;this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';">
                    <label for="portrait-upload-input" class="upload-overlay">
                        <span>Upload Portrait</span>
                    </label>
                    <input type="file" 
                           id="portrait-upload-input" 
                           accept="image/*" 
                           onchange="uploadPortrait('${normalizedName}')">
                </div>
            `;
            
            container.innerHTML = html;
            log(`Created portrait box for: ${normalizedName}`);
            
            // Check if the input was created
            const input = document.getElementById('portrait-upload-input');
            if (input) {
                log('Input element created successfully');
                log(`Input onchange: ${input.onchange}`);
                
                // Add event listener directly
                input.addEventListener('change', function(e) {
                    log('Change event fired via addEventListener');
                });
            } else {
                log('ERROR: Input element not created!');
            }
        }
        
        function checkFunction() {
            log(`uploadPortrait type: ${typeof uploadPortrait}`);
            log(`window.uploadPortrait type: ${typeof window.uploadPortrait}`);
            log(`Functions are same: ${uploadPortrait === window.uploadPortrait}`);
            
            const input = document.getElementById('portrait-upload-input');
            if (input) {
                log(`Input exists: true`);
                log(`Input onchange attribute: ${input.getAttribute('onchange')}`);
                log(`Input onchange property: ${input.onchange}`);
            } else {
                log('Input does not exist - run "Simulate Character Load" first');
            }
        }
        
        function manualTrigger() {
            const input = document.getElementById('portrait-upload-input');
            if (input) {
                log('Manually clicking input...');
                input.click();
            } else {
                log('Input not found - run "Simulate Character Load" first');
            }
        }
        
        // Log initial state
        log('Debug page loaded');
        simulateCharacterLoad();
    </script>
</body>
</html>