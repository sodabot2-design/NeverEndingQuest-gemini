<!DOCTYPE html>
<html>
<head>
    <title>Video Popup Test</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #ccc;
            padding: 40px;
        }
        
        h1 { color: #FFA500; }
        
        .test-container {
            display: flex;
            gap: 20px;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        
        .test-box {
            width: 55px;
            height: 55px;
            border: 2px solid #f44336;
            background: #333;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            font-size: 10px;
            text-align: center;
            transition: transform 0.2s;
        }
        
        .test-box:hover {
            transform: scale(1.1);
            background: #444;
        }
        
        .test-box.skeleton {
            background-image: url('/static/media/videos/skeleton_thumb.jpg');
            background-size: cover;
            background-position: center;
            text-shadow: 1px 1px 2px black;
        }
        
        /* Video popup styles */
        .video-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            pointer-events: none;
            
            /* Visibility control */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease-in-out, visibility 0s 0.2s;
        }
        
        .video-popup.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.2s ease-in-out;
        }
        
        .video-popup-content {
            position: absolute;
            width: 350px;
            border: 3px solid #FFA500;
            border-radius: 8px;
            background: #1a1a1a;
            padding: 5px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.7);
        }
        
        #popup-video {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 5px;
        }
        
        .status {
            padding: 10px;
            background: #2a2a2a;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .log {
            background: #0a0a0a;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #4CAF50;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1>Video Popup Hover Test</h1>
    
    <div class="status">
        <strong>Instructions:</strong> Hover over any skeleton box for 1 second to trigger the video popup.
        <br>Move your mouse away to hide it.
    </div>
    
    <button onclick="testDirectPopup()">Test Direct Popup (No Hover)</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <div class="test-container">
        <div class="test-box skeleton" data-name="Skeleton_1">Skel 1</div>
        <div class="test-box skeleton" data-name="Skeleton_2">Skel 2</div>
        <div class="test-box skeleton" data-name="Skeleton_3">Skel 3</div>
        <div class="test-box" data-name="Player">Player</div>
        <div class="test-box skeleton" data-name="Skeleton_4">Skel 4</div>
    </div>
    
    <h3>Debug Log:</h3>
    <div class="log" id="log"></div>
    
    <!-- Video Popup Modal -->
    <div id="video-popup" class="video-popup">
        <div class="video-popup-content">
            <video id="popup-video" autoplay loop muted playsinline>
                <source src="" type="video/mp4">
            </video>
        </div>
    </div>
    
    <script>
        let hoverTimer = null;
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Video popup functions
        function showVideoPopup(targetElement, videoSrc) {
            log('showVideoPopup called');
            
            const popup = document.getElementById('video-popup');
            const popupContent = popup.querySelector('.video-popup-content');
            const video = document.getElementById('popup-video');
            
            if (!popup || !popupContent || !video) {
                log('ERROR: Could not find popup elements');
                return;
            }
            
            log('Setting video source: ' + videoSrc);
            video.src = videoSrc;
            
            log('Making popup visible');
            popup.classList.add('visible');
            
            // Use requestAnimationFrame to ensure proper rendering
            requestAnimationFrame(() => {
                log('In requestAnimationFrame callback');
                
                const targetRect = targetElement.getBoundingClientRect();
                const popupRect = popupContent.getBoundingClientRect();
                
                log(`Target position: top=${targetRect.top}, left=${targetRect.left}`);
                log(`Popup size: width=${popupRect.width}, height=${popupRect.height}`);
                
                let top, left;
                
                // Try to position above the element
                top = targetRect.top - popupRect.height - 10;
                
                // If it goes off the top, position below
                if (top < 10) {
                    log('Positioning below (not enough room above)');
                    top = targetRect.bottom + 10;
                } else {
                    log('Positioning above');
                }
                
                // Center horizontally
                left = targetRect.left + (targetRect.width / 2) - (popupRect.width / 2);
                
                // Keep within screen bounds
                if (left < 10) {
                    left = 10;
                } else if (left + popupRect.width > window.innerWidth - 10) {
                    left = window.innerWidth - popupRect.width - 10;
                }
                
                log(`Final position: top=${top}, left=${left}`);
                
                popupContent.style.top = `${top}px`;
                popupContent.style.left = `${left}px`;
                
                video.play().catch(e => {
                    log('ERROR: Video play failed: ' + e.message);
                });
            });
        }
        
        function hideVideoPopup() {
            log('hideVideoPopup called');
            clearTimeout(hoverTimer);
            
            const popup = document.getElementById('video-popup');
            const video = document.getElementById('popup-video');
            
            if (!popup || !video) {
                log('ERROR: Could not find popup elements');
                return;
            }
            
            popup.classList.remove('visible');
            
            setTimeout(() => {
                video.pause();
                video.src = '';
                log('Video stopped and source cleared');
            }, 200);
        }
        
        // Test direct popup without hover
        function testDirectPopup() {
            log('Testing direct popup...');
            const firstSkeleton = document.querySelector('.test-box.skeleton');
            if (firstSkeleton) {
                // Use a test video or the skeleton video
                showVideoPopup(firstSkeleton, '/static/media/videos/skeleton_compressed.mp4');
                
                // Auto-hide after 3 seconds
                setTimeout(() => {
                    log('Auto-hiding after 3 seconds');
                    hideVideoPopup();
                }, 3000);
            } else {
                log('ERROR: No skeleton element found');
            }
        }
        
        // Set up hover listeners
        document.addEventListener('DOMContentLoaded', () => {
            log('Page loaded, setting up hover listeners');
            
            const skeletons = document.querySelectorAll('.test-box.skeleton');
            log(`Found ${skeletons.length} skeleton elements`);
            
            skeletons.forEach((skeleton, index) => {
                skeleton.addEventListener('mouseenter', (event) => {
                    log(`Mouse entered skeleton ${index + 1}`);
                    clearTimeout(hoverTimer);
                    
                    hoverTimer = setTimeout(() => {
                        log(`Hover timer triggered for skeleton ${index + 1}`);
                        showVideoPopup(event.currentTarget, '/static/media/videos/skeleton_compressed.mp4');
                    }, 1000);
                });
                
                skeleton.addEventListener('mouseleave', () => {
                    log(`Mouse left skeleton ${index + 1}`);
                    clearTimeout(hoverTimer);
                    hideVideoPopup();
                });
            });
            
            // Test if video file exists
            const testVideo = document.createElement('video');
            testVideo.src = '/static/media/videos/skeleton_compressed.mp4';
            testVideo.onerror = () => {
                log('WARNING: Video file not found at /static/media/videos/skeleton_compressed.mp4');
                log('Trying alternative path...');
                
                // Try without leading slash
                testVideo.src = 'static/media/videos/skeleton_compressed.mp4';
                testVideo.onerror = () => {
                    log('ERROR: Video file not accessible. Check file path and server.');
                };
                testVideo.onloadedmetadata = () => {
                    log('SUCCESS: Video found at static/media/videos/skeleton_compressed.mp4');
                };
            };
            testVideo.onloadedmetadata = () => {
                log('SUCCESS: Video file found and accessible');
            };
        });
    </script>
</body>
</html>